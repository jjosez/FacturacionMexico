{#
/**
 *  This file is part of FacturacionMexico plugin for FacturaScripts
 *  Copyright (C) 2020 Juan José Prieto Dzul <juanjoseprieto88@gmail.com>
 */
#}
{% import 'Macro/Form.html.twig' as form %}
{% set cfdi = fsc.getModel() %}

<div class="container-fluid p-0">
    {% if 'Cancelado' == cfdi.estado %}
        <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="fas fa-ban me-2"></i>
            <div><strong>Cancelado</strong></div>
        </div>
    {% endif %}

    {{ _self.blockCfdiConceptos(fsc.getConceptosProductMap(), fsc) }}

    {# Modal de búsqueda de productos #}
    <div class="modal fade" id="product-link-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="product-link-modal-title">
                        <i class="fas fa-link"></i> Vincular Producto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="product-search-input" class="form-control mb-3"
                           placeholder="Buscar por referencia o descripción...">
                    <div class="table-responsive">
                        <table class="table table-hover" id="product-table">
                            <thead class="table-light">
                            <tr>
                                <th>Referencia</th>
                                <th>Descripción</th>
                                <th>Fabricante</th>
                                <th>Precio</th>
                                <th>Acción</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% macro blockCfdiRelacionados(relacionados, fsc) %}
    {% if relacionados is not empty %}
        <div class="card mb-3">
            <div class="card-header bg-light">
                <i class="fas fa-link me-2"></i>CFDIs Relacionados
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Tipo Relación</th>
                            <th>UUID</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for rel in relacionados %}
                            <tr>
                                {% for uuid in rel.relacionados %}
                                    <td><span class="badge bg-secondary">{{ rel.tiporelacion }}</span></td>
                                    <td>{{ uuid }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
{% endmacro %}

{% macro blockCfdiConceptos(conceptos, fsc) %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
            <tr>
                <th>Cantidad</th>
                <th>Codigo Proveedor</th>
                <th>Descripción</th>
                <th class="text-end">Valor Unitario</th>
                <th class="text-end">Descuento</th>
                <th class="text-end">Importe</th>
                <th class="text-center">Acción</th>
            </tr>
            </thead>
            <tbody>
            {% for concepto in conceptos %}
                <tr data-concepto-index="{{ loop.index0 }}"
                    data-concepto='{
                            "refproveedor":"{{ concepto.NoIdentificacion }}",
                            "precio":"{{ concepto.ValorUnitario }}",
                            "cantidad":"{{ concepto.Cantidad }}",
                            "codproveedor":"{{ fsc.getModel.codproveedor }}"
                            }'>
                    <td>{{ concepto.Cantidad }}</td>
                    <td>
                        {{ concepto.NoIdentificacion }}
                        {# <div>
                                    <span class="badge bg-light text-dark">SAT: {{ concepto.ClaveProdServ }}</span>
                                    <span class="badge bg-light text-dark">{{ concepto.ClaveUnidad }}</span>
                                </div> #}
                    </td>
                    <td>
                        {{ concepto.Descripcion }}
                        <div class="producto-vinculado mt-1">
                            {% if concepto.referencia_vinculada %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> {{ concepto.referencia_vinculada }}
                                </span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-end">{{ concepto.ValorUnitario }}</td>
                    <td class="text-end">{{ concepto.Descuento }}</td>
                    <td class="text-end fw-bold">
                        {{ concepto.Importe }}

                        {% for traslado in concepto.Traslados %}
                            <div class="small text-muted">
                                <span class="badge bg-light text-dark font-monospace">Impuestos</span>
                                Base: {{ traslado.Base }}
                                Importe: {{ traslado.Importe }}
                            </div>
                        {% endfor %}
                    </td>
                    <td class="text-center">
                        <button type="button"
                                class="btn btn-sm {{ concepto.referencia_vinculada ? 'btn-outline-secondary' : 'btn-primary' }}"
                                data-action="product-link"
                                data-index="{{ loop.index0 }}"
                                data-codigo="{{ concepto.NoIdentificacion }}">
                            <i class="fas fa-link"></i> {{ concepto.referencia_vinculada ? 'Cambiar' : 'Vincular' }}
                        </button>

                        {% if not concepto.referencia_vinculada %}
                            {% set newProductUrl = fsc.buildNewProductUrl(concepto.NoIdentificacion, concepto.Descripcion) %}
                            <a href="{{ newProductUrl }}" class="btn btn-sm btn-warning" target="_blank">
                                <i class="fas fa-plus"></i> Registrar
                            </a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endmacro %}

<script src="{{ asset('Plugins/FacturacionMexico/Assets/JS/CfdiSupplier.js') }}"></script>
